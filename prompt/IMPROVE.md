# 改善アイデア

- 環境変数バリデーションとロギングを入口で徹底する（`src/thesis_generator/config.py`, `app.py`, `main.py`）。`.env` を `python-dotenv` で自動ロードし、不足キーは WARNING/ERROR を stderr に出しつつ必須欠落時は即時終了、オプショナル欠落は継続＋限定機能を告知。起動時にロガーを初期化して chore/env-missing-logging を解消する。
- ツールごとの設定モデルを分離し、不要キー欠落での失敗を防ぐ（`config.py`, `tools/openalex.py`, `tools/code_execution.py`）。現状 OpenAlex の mailto 取得でも `OPENAI_API_KEY`/`SCITE_API_KEY` が必須になるため、ツール単位の Settings（必須キーセットを引数で渡す等）を用意し、OpenAlex/Scite/E2B それぞれ必要なキーだけを要求する。
- LangGraph のルーティングとエージェント構成を強化する（`graph/builder.py`, `graph/supervisor.py`, `agents/planner.py` ほか）。`plan_master_thesis` を初手ノードにして outline/hypothesis/novelty をロックし、quality gate 結果と `user_approval_status` で researcher/writer/validator のループを制御。placeholder の section/doc 追加をやめ、checkpoint の thread_id を state 由来で固定。`reduce_state` に execution_trace 等の append マージ用アグリゲータも追加する。
- Researcher の出力品質を高める（`agents/researcher.py`, `tools/ingest.py`, `state.py`）。doi/paper_id で重複除去し、視点ごとの質問も `execution_trace` に積む。OpenAlex 検索結果を ingest して `vector_store_uri` を更新、`knowledge_graph` にメタデータを蓄積。`max_results` やフィルタを年範囲・スタイルに応じて可変化する。
- Writer の引用・スタイル整合性を担保する（`agents/writer.py`, `quality.py`）。`assign_sources_to_sections` で citations を初期化し、欠落があれば再生成ループを回す。`style_guide`/`target_word_count` からセクション長を配分し、`chapter_summaries` を維持。RAG 取得を挟み、paragraph ごとに assigned_sources を優先利用する。
- Validator と品質ゲート結果を state に反映する（`agents/validator.py`, `quality.py`）。`hallucination_flags` の重複除去、`manual_review_required` を `user_approval_status`/`next_node` に伝搬、セクション status を validated/needs_review で更新。citation coverage・novelty のブロック条件を supervisor ルートに組み込み、quality レポートを execution_trace に残す。
- ツール層の堅牢性を上げる（`tools/openalex.py`, `tools/citation_check.py`, `tools/ingest.py`, `tools/pdf_parser.py`）。OpenAlex 呼び出しに timeout/例外ハンドリングを追加し、abstract 無しのフォールバックもログ。ingest は単語重複スコアのみなので埋め込み検索とメタデータフィルタを導入し、`vector_store_uri` の永続化インタフェースを抽象化。citation_check は `evaluate_citations_with_fallback` を `__all__` に出し、Scite キー欠落時に警告ログを出す。pdf_parser は UA/Content-Length ガードを付け、大きな PDF をストリーミングしつつエラー情報を集約する。
- サンドボックス安全性と I/O 制限を強化する（`tools/code_execution.py`, `security.py`）。`_validate_code_safety` で subprocess/os.remove/パストラバーサルを検知し、アップロードファイル名を正規化して `/home/user` 以下に固定、生成ファイル数/サイズの上限を設ける。実行ログや生成ファイルを SLO/trace に添付できるようにする。
- 評価と UX の可観測性を上げる（`evaluation.py`, `app.py`, `main.py`）。`run_e2e_suite` で quality gate/novelty/citation coverage を集計して JSON レポートを残し、StreamingResponse に進捗・エラーイベントを流す。CLI 失敗時は診断を stderr に出力し、成功時は出力パスや主要メトリクスをログする。
